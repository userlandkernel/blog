# XNU Kernel Stack Segment Overflow (0-day for days now)

## Preface
The XNU kernel by Apple as found in iOS and macOS contained a vulnerability in kernel stack initialization.  
This vulnerability does require additional bugs to exploit but can be used as part of a chain of persistent bugs.  
The most interesting part of it, is that it might enable attackers to bypass the hardware-enforced memory protection on the newer ARMv8 Apple devices.  

## Analysis
Since the XNU source code is publicly available online it can be analyzed and improved by any experienced programmer and researcher.  
I started analysis of the kernel initialization after reading an article from a popular hacker (S1guza) in the iOS scene.  
In his writeup he explains how the hardware-enforced memory protection prevents attackers from patching critical structures and memory pages or executing critical system instructions.  
This protection however does not make jailbreaking impossible, but does make it impossible to run kloader64 for loading a new bootchain from the kernel.  
Therefore it was my goal to analyze the initialization sequence of the kernel to find flaws that may aid in altering kernel pages or inserting critical instructions for faking the memory access rights of the firstlevel-entry memory pagetable entries.  

## Segmentation
A binary executable mach-o file is devided into segments, each segment having its own boundaries.  
One of these segments is the stack, which pre-managed memory assigned at compilation for the execution of the program.  
The stack is initialized at runtime in the XNU kernel, during the early intialization stage shortly after boot.  
Therefore I decided to analyze the initialization of the stack to see whether it contained vulnerable code or logic.  
To my surprise there was a kernel bootargument that could be passed which sets the number of stack pages to allocate.  
Since the stack segment has boundaries two major possible issues came through my head:

1. The kernel has improper boundary checking for the number of kernel stack pages in the boot-argument.  
2. The boot-argument can specify a number of kernel stack pages that is too small, causing uninitialized stack memory issues.  

To my surprise I already had luck with both issues.
The kernel did not properly check boundaries for the number of kernel stack pages, thus enabling attackers to overflow the kernel stack segment.  
The second issue also seemed to work, there is no minimum number of stack pages checked or set, so one can specify less stack pages than needed.  
The boot-argument also allowed an integer overflow to occur but that is not considered an issue since we are not dealing with any pointers here.  

## Proof of concept
A proof of concept still requires a jailbroken device.   
Apple mostlikely will not take this issue serious for that reason.  
However, since I really wanted to test my findings a PVT development stage iPad helped a lot in creating a proof of concept.  
The serial log did show a panic as one can see in the image below.
I expect more initialization issues to exist in the telemetry boot-arguments of the kernel.  
Those I will examine too.  
The proof of concept that works on development devices is attached below.  
At time of writing this, Apple has not patched the security issue as the risk is mostlikely too low in general.  

